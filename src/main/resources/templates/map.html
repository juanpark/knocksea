<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ë‚šì‹œí„° ì§€ë„</title>
  <style>
    body {
      display: flex;
      flex-direction: row;
      margin: 0;
      height: 100vh;
      overflow: hidden; /* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì œê±° */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f8;
    }

    .navbar {
      position: fixed;
      width: 100%;
      top: 0;
      background-color: #2196F3;
      padding: 15px 30px;
      color: white;
      font-size: 24px;
      font-weight: bold;
      z-index: 1001;
    }

    .side-panel {
      width: 500px;
      /*margin-top: 60px; !* ë„¤ë¹„ë°” ë†’ì´ ê³ ë ¤ *!*/
      height: calc(100vh - 60px);
      background-color: #ffffff;
      border-right: 1px solid #ddd;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      z-index: 999;
      padding: 16px;
      overflow-y: auto; /* ì‚¬ì´ë“œ íŒ¨ë„ë§Œ ìŠ¤í¬ë¡¤ */
      scrollbar-width: none; /* Firefox */
      position: absolute;
      top: 60px;
      transition: transform 0.3s ease;
      transform: translateX(0); /* ê¸°ë³¸ê°’: ì—´ë ¤ ìˆìŒ */
    }

    .side-panel.closed {
      transform: translateX(-100%);
    }

    .side-panel::-webkit-scrollbar {
      display: none; /* Chrome, Safari */
    }

    #map {
      flex: 1;
      height: 100vh;
    }

    .toggle-button {
      position: absolute;
      left: 532px;
      top: 120px;
      background-color: white;
      color: #2196F3;
      border: none;
      padding: 8px 16px;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      font-weight: bold;
      z-index: 999;
      box-shadow: 5px 1px 5px rgba(0,0,0,0.2);
      transition: left 0.3s ease;
      height: 50px;
    }

    .toggle-button.closed {
      left: 0;
    }

    .post-card {
      background-color: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .post-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .post-title {
      font-size: 20px;
      color: #2196F3;
      text-decoration: none;
      font-weight: bold;
    }

    .post-title:hover {
      text-decoration: underline;
    }

    .post-info {
      font-size: 14px;
      color: #777;
      margin-top: 8px;
    }

    .no-posts {
      text-align: center;
      font-size: 18px;
      color: #777;
      margin-top: 20px;
    }

    .spot-column{

    }

    .spot-row{
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .spot-image img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      background-color: #ddd;
    }

    .divider {
      border-top: 1px solid #ddd;
      margin: 20px 0;
    }

    #postPanel {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #postList {
      width: 100%;
    }

    .info{
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
  </style>

  <!-- âœ… Google Maps API í‚¤ í•„ìš” -->
  <script async defer
          th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapKey} + '&callback=initMap'}">
  </script>
</head>
<body>

<div class="navbar">
  knocksea
</div>

<!-- ì‚¬ì´ë“œ íŒ¨ë„: ì§€ì—­ ë“œë¡­ë°•ìŠ¤ + ë‚šì‹œí„° ì •ë³´ + ê²Œì‹œê¸€ ëª©ë¡ -->
<div class="side-panel" id="sidePanel">

  <!-- ë“œë¡­ë°•ìŠ¤ -->
  <div style="margin-bottom: 20px;">
    <label for="regionSelect">ì§€ì—­ ì„ íƒ:</label>
    <select id="regionSelect" onchange="filterMarkersByRegion()">
      <option value="ì „ì²´">ì „ì²´</option>
      <option value="ì„œìš¸íŠ¹ë³„ì‹œ">ì„œìš¸íŠ¹ë³„ì‹œ</option>
      <option value="ì¸ì²œê´‘ì—­ì‹œ">ì¸ì²œê´‘ì—­ì‹œ</option>
      <option value="ê²½ê¸°ë„">ê²½ê¸°ë„</option>
      <option value="ì¶©ì²­ë¶ë„">ì¶©ì²­ë¶ë„</option>
      <option value="ì¶©ì²­ë‚¨ë„">ì¶©ì²­ë‚¨ë„</option>
      <option value="ì „ë¼ë¶ë„">ì „ë¼ë¶ë„</option>
      <option value="ì „ë¼ë‚¨ë„">ì „ë¼ë‚¨ë„</option>
      <option value="ê²½ìƒë¶ë„">ê²½ìƒë¶ë„</option>
      <option value="ê²½ìƒë‚¨ë„">ê²½ìƒë‚¨ë„</option>
    </select>
  </div>

  <!-- ë‚šì‹œí„° ì •ë³´ -->
  <div class="spot-image" id="spotImage">
    <img src="">
  </div>
  <div class="info">
    <div class="spot-column">
      <div class="spot-row">
        <span id="spotName">ì†¡ì¹˜ë‚šì‹œí„°</span>
        <div id="spot-category">
          <span id="category">í‰ì§€</span>
        </div>
      </div>
    </div>

    <div class="spot-column">
      <div class="spot-row">
        <div class="spot-icon-row">
          <span class="icon">ğŸ“</span>
          <span id="spotAddress">ì „ë¶íŠ¹ë³„ìì¹˜ë„ ë‚¨ì›ì‹œ ì£¼ì²œë©´ ì›…ì¹˜ê¸¸ 20</span>
        </div>
        <div class="spot-icon-row">
          <span class="icon">ğŸ£</span>
          <span id="spotFish">ë¶•ì–´, ì‰ì–´, í–¥ì–´</span>
        </div>
      </div>
    </div>

    <div class="spot-column">
      <div class="spot-row">
        <div class="spot-icon-row">
          <span class="icon">ğŸ“</span>
          <span id="spotPhone">ë“±ë¡ë˜ì§€ ì•ŠìŒ</span>
        </div>
        <div class="spot-icon-row">
          <span class="icon">ğŸ’°</span>
          <span id="spotPrice">20,000ì›</span>
        </div>
      </div>
    </div>

    <div class="spot-column">
      <div class="spot-updated">ë°ì´í„° ìˆ˜ì§‘ì¼ : <span id="spot-updated">2024-07-16</span></div>
    </div>
  </div>

  <!-- êµ¬ë¶„ì„  -->
  <div class="divider"></div>

  <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
  <div id="postPanel">
    <h1>ê²Œì‹œê¸€ ëª©ë¡</h1>
    <div id="postList"></div>
  </div>
</div>

<!-- í† ê¸€ ë²„íŠ¼ -->
<button class="toggle-button" id="toggleButton" onclick="toggleSidePanel()">â®œ</button>

<div id="map"></div>

<script>
  //ê¸°ì¡´ êµ¬ê¸€ë§µ ì½”ë“œ
  let map;

  function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 36.5, lng: 127.5 },
          zoom: 7,
      });

      fetch('/map/fishing-spots')
          .then(res => res.json())
          .then(data => {
              data.forEach(spot => {
                  if (spot.latitude && spot.longitude && !isNaN(spot.latitude) && !isNaN(spot.longitude)) {
                      const pos = { lat: spot.latitude, lng: spot.longitude };

                      const marker = new google.maps.Marker({
                          position: pos,
                          map: map,
                          title: spot.name,
                          icon: {
                              url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                          }
                      });

                      // marker.addListener("click", () => {
                      //     showInfoPanel(spot);
                      // });
                  }
              });
          })
          .catch(err => {
              console.error("ë§ˆì»¤ ë¡œë”© ì‹¤íŒ¨:", err);
          });
  }

  let panelVisible = true;
  const toggleButton = document.getElementById("toggleButton");
  const sidePanel = document.getElementById("sidePanel");

  function toggleSidePanel() {
    panelVisible = !panelVisible;

    if (panelVisible) {
      sidePanel.classList.remove("closed");
      toggleButton.classList.remove("closed");
      toggleButton.innerText = "â®œ";
      toggleButton.style.left = "532px";
      loadPosts();
    } else {
      sidePanel.classList.add("closed");
      toggleButton.classList.add("closed");
      toggleButton.innerText = "â®";
      toggleButton.style.left = "0";
    }

      // panelVisible = !panelVisible;
  }

  function loadPosts() {
      fetch('/posts/api')
          .then(res => res.json())
          .then(data => {
              const container = document.getElementById('postList');
              container.innerHTML = '';

              if (data.length === 0) {
                  container.innerHTML = '<div class="no-posts">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                  return;
              }

              data.forEach(post => {
                  const postCard = document.createElement('div');
                  postCard.className = 'post-card';
                  postCard.innerHTML = `
                      <a href="/posts/${post.postsId}" class="post-title">${post.title}</a>
                      <div class="post-info">ì¡°íšŒìˆ˜: ${post.viewCount}</div>
                  `;
                  container.appendChild(postCard);
              });
          })
          .catch(err => console.error('ê²Œì‹œê¸€ ë¡œë”© ì‹¤íŒ¨:', err));
  }

  function loadRandomFishingSpot() {
      fetch('/map/fishing-spots')
          .then(res => res.json())
          .then(data => {
              if (data.length === 0) return;

              const randomIndex = Math.floor(Math.random() * data.length);
              const spot = data[randomIndex];

              document.getElementById("spotName").innerText = spot.name || "ì´ë¦„ ì—†ìŒ";
              document.getElementById("category").innerText = spot.spotType || "ì •ë³´ ì—†ìŒ";
              document.getElementById("spotAddress").innerText = spot.address || "ì •ë³´ ì—†ìŒ";
              document.getElementById("spotFish").innerText = spot.fishType || "ì •ë³´ ì—†ìŒ";
              document.getElementById("spotPhone").innerText = (spot.phone && spot.phone !== "NaN") ? spot.phone : "ë“±ë¡ë˜ì§€ ì•ŠìŒ";
              document.getElementById("spotPrice").innerText = spot.fee || "ì •ë³´ ì—†ìŒ";
              document.getElementById("spot-updated").innerText = spot.updatedAt || "ì •ë³´ ì—†ìŒ";
          })
          .catch(err => console.error('ë‚šì‹œí„° ì •ë³´ ë¡œë”© ì‹¤íŒ¨:', err));
  }

  let fishingSpots = [];
  let displayedSpots = [];

  function loadFishingSpots() {
      fetch('/map/fishing-spots')
          .then(res => res.json())
          .then(data => {
              fishingSpots = data;
              displayedSpots = data;
              renderMarkers();
          })
          .catch(err => console.error('ë‚šì‹œí„° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', err));
  }

  function renderMarkers() {
      console.log('í˜„ì¬ ë§ˆì»¤:', displayedSpots);
      // êµ¬ê¸€ë§µ ì£¼ì„ ìœ ì§€
  }

  function filterMarkersByRegion() {
      const selectedRegion = document.getElementById('regionSelect').value;

      if (selectedRegion === 'ì „ì²´') {
          displayedSpots = fishingSpots;
      } else {
          displayedSpots = fishingSpots.filter(spot => spot.city === selectedRegion);
      }

      renderMarkers();
      console.log('ì„ íƒí•œ ì§€ì—­:', selectedRegion);
      console.log('í•„í„°ë§ëœ ë°ì´í„°:', displayedSpots);
  }

  window.onload = function () {
      loadRandomFishingSpot();
      loadPosts();
      loadFishingSpots();
  }
</script>

</body>
</html>