<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ë‚šì‹œí„° ì§€ë„</title>
  <style>
    body {
      display: flex;
      flex-direction: row;
      margin: 0;
      height: 100vh;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f8;
      padding-top: 100px;
    }

    .side-panel {
      width: 500px;
      height: calc(100vh - 60px);
      background-color: #ffffff;
      border-right: 1px solid #ddd;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      z-index: 9999;
      padding: 16px;
      overflow-y: auto;
      scrollbar-width: none;
      position: fixed;
      top: 105px;
      transition: transform 0.3s ease;
      transform: translateX(0);
    }

    .side-panel.closed {
      transform: translateX(-100%);
    }

    .side-panel::-webkit-scrollbar {
      display: none; /* Chrome, Safari */
    }

    #map {
      flex: 1;
      height: 100vh;
      z-index: 0;
    }

    .toggle-button {
      position: fixed;
      left: 532px;
      top: 120px;
      background-color: white;
      color: #2196F3;
      border: none;
      padding: 8px 16px;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      font-weight: bold;
      z-index: 9999;
      box-shadow: 5px 1px 5px rgba(0,0,0,0.2);
      transition: left 0.3s ease;
      height: 50px;
    }

    .toggle-button.closed {
      left: 0;
    }

    .post-card {
      background-color: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .post-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .post-title {
      font-size: 20px;
      color: #2196F3;
      text-decoration: none;
      font-weight: bold;
    }

    .post-title:hover {
      text-decoration: underline;
    }

    .post-info {
      font-size: 14px;
      color: #777;
      margin-top: 8px;
    }

    .no-posts {
      text-align: center;
      font-size: 18px;
      color: #777;
      margin-top: 20px;
    }

    .spot-image img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      background-color: #ddd;
    }

    .divider {
      border-top: 1px solid #ddd;
      margin: 20px 0;
    }

    #postPanel {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #postList {
      width: 100%;
    }

    .spot-info{
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }

    .info-column{
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .info-row{
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-icon-row{

    }

    .info-details{
      display: flex;
      gap: 40px;
    }

    .details-text{
      font-size:1.0rem;
    }

    #spotName{
      font-size: 1.5rem;
      font-weight: bolder;
    }

    #spotCategoryWrapper{
      width: fit-content;
      height: 100%;
      box-shadow: 0px 0px 4px #848383;
      border-radius: 4px;
      line-height: inherit;
      padding: 4px;
    }

    #spotUpdatedWrapper  {
      font-size: 0.8rem;
      color: #8e8e8e;
    }

    #spotUpdated{
      font-size: 0.8rem;
      color: #8e8e8e;
    }
  </style>

  <!-- âœ… Google Maps API í‚¤ í•„ìš” -->
  <script async defer
          th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapKey} + '&callback=initMap'}">
  </script>

  <link rel="stylesheet" th:href="@{/css/nav.css}">
</head>
<body>

<div th:replace="nav :: navbar"></div>

<!-- ì‚¬ì´ë“œ íŒ¨ë„: ì§€ì—­ ë“œë¡­ë°•ìŠ¤ + ë‚šì‹œí„° ì •ë³´ + ê²Œì‹œê¸€ ëª©ë¡ -->
<div class="side-panel" id="sidePanel">

  <!-- ë“œë¡­ë°•ìŠ¤ -->
  <div style="margin-bottom: 20px;">
    <label for="regionSelect">ì§€ì—­ ì„ íƒ:</label>
    <select id="regionSelect" onchange="filterMarkersByRegion()">
      <option value="ì „ì²´">ì „ì²´</option>
      <option value="ì„œìš¸íŠ¹ë³„ì‹œ">ì„œìš¸íŠ¹ë³„ì‹œ</option>
      <option value="ì¸ì²œê´‘ì—­ì‹œ">ì¸ì²œê´‘ì—­ì‹œ</option>
      <option value="ê²½ê¸°ë„">ê²½ê¸°ë„</option>

      <option value="ëŒ€ì „ê´‘ì—­ì‹œ">ëŒ€ì „ê´‘ì—­ì‹œ</option>
      <option value="ì¶©ì²­ë¶ë„">ì¶©ì²­ë¶ë„</option>
      <option value="ì¶©ì²­ë‚¨ë„">ì¶©ì²­ë‚¨ë„</option>
      <option value="ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>

      <option value="ì „ë¶íŠ¹ë³„ìì¹˜ë„">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
      <option value="ì „ë¼ë‚¨ë„">ì „ë¼ë‚¨ë„</option>

      <option value="ëŒ€êµ¬ê´‘ì—­ì‹œ">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
      <option value="ìš¸ì‚°ê´‘ì—­ì‹œ">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
      <option value="ë¶€ì‚°ê´‘ì—­ì‹œ">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
      <option value="ê²½ìƒë¶ë„">ê²½ìƒë¶ë„</option>
      <option value="ê²½ìƒë‚¨ë„">ê²½ìƒë‚¨ë„</option>

      <option value="ê°•ì›íŠ¹ë³„ìì¹˜ë„">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
      <option value="ì œì£¼íŠ¹ë³„ìì¹˜ë„">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
    </select>
  </div>

  <!-- ë‚šì‹œí„° ì‚¬ì§„ -->
  <div class="spot-image" id="spotImage">
    <img src="" alt="ë‚šì‹œí„° ì´ë¯¸ì§€">
  </div>

  <!--ë‚šì‹œí„° ì •ë³´-->
  <div class="spot-info">
    <div class="info-column">
      <div class="info-row">
        <span id="spotName" class="details-text">ì†¡ì¹˜ë‚šì‹œí„°</span>
        <div id="spotCategoryWrapper">
          <span id="category" class="details-text">í‰ì§€</span>
        </div>
      </div>
    </div>

    <div class="info-details">

      <div class="info-column">
        <div class="info-icon-row">
          <span class="icon">ğŸ“</span>
          <span id="spotAddress" class="details-text">ì „ë¶íŠ¹ë³„ìì¹˜ë„ ë‚¨ì›ì‹œ ì£¼ì²œë©´ ì›…ì¹˜ê¸¸ 20</span>
        </div>
        <div class="spot-icon-row">
          <span class="icon">ğŸ“</span>
          <span id="spotPhone" class="details-text">ë“±ë¡ë˜ì§€ ì•ŠìŒ</span>
        </div>

      </div>
      <div class="info-column">
        <div class="info-icon-row">
          <span class="icon">ğŸ£</span>
          <span id="spotFish" class="details-text">ë¶•ì–´, ì‰ì–´, í–¥ì–´</span>
        </div>
        <div class="spot-icon-row">
          <span class="icon">ğŸ’°</span>
          <span id="spotPrice" class="details-text">20,000ì›</span>
        </div>
      </div>
    </div>

    <div class="info-column">
      <div class="info-row" id="spotUpdatedWrapper">
        ë°ì´í„° ìˆ˜ì§‘ì¼ : <span id="spotUpdated" class="details-text">2024-07-16</span>
      </div>
    </div>
  </div>

  <!-- êµ¬ë¶„ì„  -->
  <div class="divider"></div>

  <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
  <div id="postPanel">
    <h1>ê²Œì‹œê¸€ ëª©ë¡</h1>
    <div id="postList"></div>
  </div>
</div>

<!-- í† ê¸€ ë²„íŠ¼ -->
<button class="toggle-button" id="toggleButton" onclick="toggleSidePanel()">â®œ</button>

<div id="map"></div>

<script>
  //ê¸°ì¡´ êµ¬ê¸€ë§µ ì½”ë“œ
  let map;
  let fishingSpots=[];
  let displayedSpots=[];
  let markers=[];

  let panelVisible = true;
  const toggleButton = document.getElementById("toggleButton");
  const sidePanel = document.getElementById("sidePanel");


  function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 36.5, lng: 127.5 },
          zoom: 7,
      });

      fetch('/map/fishing-spots')
      .then(res => res.json())
      .then(data => {
        fishingSpots = data;
        displayedSpots = data;
        renderMarkers(); // ì§€ë„ ìƒì„± ì´í›„ ë§ˆì»¤ ë Œë”ë§
      })
      .catch(err => console.error('ë‚šì‹œí„° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', err));
  }

  // ì‚¬ì´ë“œ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ ì—´ë¦¼, ë‹«í˜ í•¨ìˆ˜
  function toggleSidePanel() {
    panelVisible = !panelVisible;

    if (panelVisible) {
      sidePanel.classList.remove("closed");
      toggleButton.classList.remove("closed");
      toggleButton.innerText = "â®œ";
      toggleButton.style.left = "532px";
      loadPosts();
    } else {
      sidePanel.classList.add("closed");
      toggleButton.classList.add("closed");
      toggleButton.innerText = "â®";
      toggleButton.style.left = "0";
    }
  }

  // ë§ˆì»¤ í´ë¦­ ì‹œ ì‚¬ì´ë“œ íŒ¨ë„ í•­ìƒ ì—´ë¦¬ê²Œ í•˜ëŠ” í•¨ìˆ˜
  function openSidePanel(){
    panelVisible = true;
    sidePanel.classList.remove("closed");
    toggleButton.classList.remove("closed");
    toggleButton.innerText = "â®œ";
    toggleButton.style.left = "532px";
  }

  // ë§ˆì»¤ í´ë¦­ ì‹œ ì¥ì†Œ ë°ì´í„° ì„¤ì • í•¨ìˆ˜
  function loadFishingSpot(spot) {
    document.getElementById("spotName").innerText = spot.name || "ì´ë¦„ ì—†ìŒ";
    document.getElementById("category").innerText = spot.spotType || "ì •ë³´ ì—†ìŒ";
    document.getElementById("spotAddress").innerText = spot.address || "ì •ë³´ ì—†ìŒ";
    document.getElementById("spotFish").innerText = spot.fishType || "ì •ë³´ ì—†ìŒ";
    document.getElementById("spotPhone").innerText = (spot.phone && spot.phone !== "NaN") ? spot.phone : "ë“±ë¡ë˜ì§€ ì•ŠìŒ";
    document.getElementById("spotPrice").innerText = spot.fee || "ì •ë³´ ì—†ìŒ";
    document.getElementById("spotUpdated").innerText = spot.updatedAt || "ì •ë³´ ì—†ìŒ";
  }

  // ê²Œì‹œë¬¼ ë¦¬ìŠ¤íŠ¸ í˜¸ì¶œ í•¨ìˆ˜
  function loadPosts() {
      fetch('/posts/api')
          .then(res => res.json())
          .then(data => {
              const container = document.getElementById('postList');
              container.innerHTML = '';

              if (data.length === 0) {
                  container.innerHTML = '<div class="no-posts">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                  return;
              }

              data.forEach(post => {
                  const postCard = document.createElement('div');
                  postCard.className = 'post-card';
                  postCard.innerHTML = `
                      <a href="/posts/${post.postsId}" class="post-title">${post.title}</a>
                      <div class="post-info">ì¡°íšŒìˆ˜: ${post.viewCount}</div>
                  `;
                  container.appendChild(postCard);
              });
          })
          .catch(err => console.error('ê²Œì‹œê¸€ ë¡œë”© ì‹¤íŒ¨:', err));
  }

  // ì§€ì—­ì— ë”°ë¼ ë§ˆì»¤ í•„í„°ë§
  function renderMarkers() {
      console.log('í˜„ì¬ ë§ˆì»¤:', displayedSpots);
      // êµ¬ê¸€ë§µ ì£¼ì„ ìœ ì§€
       markers.forEach(marker => marker.setMap(null));
       markers = [];

       // í•„í„°ëœ ë§ˆì»¤ë§Œ ë‹¤ì‹œ ìƒì„±
       displayedSpots.forEach(spot => {
       if (spot.latitude && spot.longitude && !isNaN(spot.latitude) && !isNaN(spot.longitude)) {
          const pos = { lat: spot.latitude, lng: spot.longitude };

          const marker = new google.maps.Marker({
                position: pos,
                map: map,
                title: spot.name,
                icon: {
                    url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                }
          });

          marker.addListener("click", () => {
              loadFishingSpot(spot);
              fetch('/map/spot-image')
                  .then(res => res.json())
                  .then(data => {
                      const imageUrl = data.imageUrl;
                      const imgElement = document.getElementById("spotImage").querySelector("img");
                      imgElement.src = imageUrl;
                  })
                      .catch(err => {
                        console.error(err);
                        document.getElementById("spotImage").querySelector("img").src = "https://placehold.co/600x400";
                      });
                openSidePanel();
          });

          markers.push(marker); // ìƒˆë¡œ ì¶”ê°€ëœ ë§ˆì»¤ ì €ì¥
        }
    });
  }

  function filterMarkersByRegion() {
      const selectedRegion = document.getElementById('regionSelect').value;

      if (selectedRegion === 'ì „ì²´') {
          displayedSpots = fishingSpots;
      } else {
          displayedSpots = fishingSpots.filter(spot => spot.city === selectedRegion);
      }

      renderMarkers();
      console.log('ì„ íƒí•œ ì§€ì—­:', selectedRegion);
      console.log('í•„í„°ë§ëœ ë°ì´í„°:', displayedSpots);
  }

  window.onload = function () {
      loadPosts();
      initMap();
  }
</script>

</body>
</html>