<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background-color: #f4f6f8;
        padding-top: 100px;
      }

      .container {
        max-width: 800px;
        margin: 30px auto;
        padding: 0 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
      }

      .status-badge {
        border-radius: 40px;
        padding: 0.6rem 0.7rem;
        color: white;
        margin-right: 1rem;
        font-weight: bold;
      }

      .status-waiting {
        background-color: #909090;
      }
      .status-completed {
        background-color: #2196f3;
      }
      .status-adopted {
        background-color: #1c9f3f;
      }

      .title {
        flex: auto;
        font-size: 2rem;
        font-weight: 600;
      }

      .category {
        color: #757474;
      }

      .post-meta-box {
        background-color: #f9f9f9;
        padding: 15px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #555;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .left-info {
        display: flex;
        gap: 30px;
      }

      .right-info {
        white-space: nowrap;
      }

      .post-content-box {
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 30px;
        background-color: #fff;
      }

      .post-content {
        font-size: 16px;
        line-height: 1.6;
        white-space: pre-wrap;
        color: #333;
      }

      .tag {
        display: inline-block;
        border: 2px solid #74bef8;
        border-radius: 40px;
        padding: 0.35rem 1rem;
        color: #288ad8;
        font-size: 0.8rem;
        margin-right: 0.5rem;
        margin-bottom: 1rem;
      }

      /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .button-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .btn {
        display: inline-block;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        background-color: #2196f3;
        color: white;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
        transition: background-color 0.2s;
        font-weight: bold;
      }

      .btn:hover {
        background-color: #1976d2;
      }

      .btn-delete {
        background-color: #f44336;
      }

      .btn-delete:hover {
        background-color: #e53935;
      }

      /* ëª©ë¡ ë²„íŠ¼ */
      .back-link {
        display: inline-block;
        color: #2196f3;
        text-decoration: none;
        font-weight: bold;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      /*   ëŒ“ê¸€ css  */
      /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .comment-btn {
        padding: 6px 12px;
        margin-right: 5px;
        font-size: 13px;
        font-weight: 600;
        color: white;
        background-color: #2196f3;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      /* í˜¸ë²„ íš¨ê³¼ */
      .comment-btn:hover {
        background-color: #1976d2;
      }

      /* ì±„íƒ ë²„íŠ¼ì€ ì´ˆë¡ìƒ‰ */
      .adopt-btn {
        background-color: #4caf50;
      }
      .adopt-btn:hover {
        background-color: #388e3c;
      }

      /* ì‚­ì œ ë²„íŠ¼ì€ ë¹¨ê°„ìƒ‰ */
      .delete-btn {
        background-color: #f44336;
      }
      .delete-btn:hover {
        background-color: #d32f2f;
      }

      /* ì±„íƒ í‘œì‹œ */
      .adopted-label {
        margin-left: 8px;
        color: green;
        font-weight: bold;
      }

      .post-vote-btn{
        border: none;
        background-color: white;
        width: fit-content;
        height: 100%;
        box-shadow: 0px 1px 3px #dad5d5;
        border-radius: 4px;
        line-height: inherit;
        padding: 4px;
        cursor: pointer;
      }
      .post-vote-btn:hover{
        background-color: #9fd6ed;
      }
      .vote-container{
        display: flex;
        width: 100%;
        margin-top: 20px;
        justify-content: center;
        gap: 20px;
      }
      .post-vote-btn.active {
        background-color: #e3f2fd; /* ì‚´ì§ ì–´ë‘ìš´ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
        font-weight: bold;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      }
    </style>

    <link rel="stylesheet" th:href="@{/css/nav.css}" />
  </head>

  <body>
    <div th:replace="nav :: navbar"></div>

    <div class="container">
      <!-- ê²Œì‹œê¸€ í—¤ë” -->
      <div style="display: flex; align-items: center">
        <div
          th:class="'status-badge ' +
                      (${post.status} == 'WAITING' ? 'status-waiting' :
                       (${post.status} == 'COMPLETED' ? 'status-completed' : 'status-adopted'))"
          th:text="${post.status} == 'WAITING' ? 'ëŒ€ê¸°' :
                       (${post.status} == 'COMPLETED' ? 'ì™„ë£Œ' : 'ì±„íƒ')"
        >
          ìƒíƒœ
        </div>
        <div class="title" th:text="${post.title}">ê²Œì‹œê¸€ ì œëª©</div>
        <div
          class="category"
          th:each="category : ${post.categoryNames}"
          th:text="${category}"
        >
          ì¹´í…Œê³ ë¦¬
        </div>
      </div>

      <!-- ì‘ì„±ì / ì¡°íšŒìˆ˜ / ì‘ì„±ì¼ or ìˆ˜ì •ì¼ êµ¬ì—­ -->
      <div class="post-meta-box">
        <div class="left-info">
          <div>ì‘ì„±ì: <span th:text="${post.userName}">ì‘ì„±ì</span></div>
          <div>ì¡°íšŒìˆ˜: <span th:text="${post.viewCount}"></span></div>
            <div>ëŒ“ê¸€ìˆ˜: <span th:text="${post.commentCount}"></span></div>
        </div>
        <div class="right-info">
          <!-- ìˆ˜ì •í•œ ê²½ìš°: ìˆ˜ì •ì¼ë§Œ ì¶œë ¥ -->
          <div
            th:if="${post.updatedAt != null and post.updatedAt != post.createdAt}"
          >
            ìˆ˜ì •ì¼:
            <span
              th:text="${#temporals.format(post.updatedAt, 'yyyy-MM-dd HH:mm')}"
            ></span>
          </div>
          <!-- ìˆ˜ì • ì•ˆ í•œ ê²½ìš°: ì‘ì„±ì¼ ì¶œë ¥ -->
          <div
            th:if="${post.updatedAt == null or post.updatedAt == post.createdAt}"
          >
            ì‘ì„±ì¼:
            <span
              th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"
            ></span>
          </div>
        </div>
      </div>

      <!-- ë³¸ë¬¸ êµ¬ì—­ -->
      <div class="post-content-box">
        <div class="post-content" th:text="${post.content}">ê²Œì‹œê¸€ë‚´ìš©</div>
        <div class="vote-container">
          <button class="post-vote-btn" id="like">ğŸ‘ ì¢‹ì•„ìš” <span id="likeCount">0</span></button>
          <button class="post-vote-btn" id="dislike">ğŸ‘ ì‹«ì–´ìš” <span id="dislikeCount">0</span></button>
        </div>
      </div>

      <!-- íƒœê·¸ ëª©ë¡ -->
      <div>
        <span class="tag" th:each="tag : ${post.tagNames}" th:text="${tag}"
          >íƒœê·¸ëª…</span
        >
      </div>

      <!-- ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼ -->
      <div class="button-group">
        <a th:href="@{/posts/{id}/edit(id=${post.postsId})}" class="btn"
          >ìˆ˜ì •í•˜ê¸°</a
        >
        <a
          href="#"
          th:onclick="|deletePost(${post.postsId})|"
          class="btn btn-delete"
          >ì‚­ì œí•˜ê¸°</a
        >
      </div>

      <!-- ê²Œì‹œê¸€ ID, ì‘ì„±ì ID (ë°±ì—”ë“œì—ì„œ ì „ë‹¬) -->
      <input type="hidden" id="postId" th:value="${post.postsId}" />
      <input type="hidden" id="postOwnerId" th:value="${post.userId}" />
      <input type="hidden" id="currentUserId" th:value="${currentUserId}" />

      <!-- ëŒ“ê¸€ ì˜ì—­ ì‹œì‘ -->
      <div id="comment-container">
        <h3>ëŒ“ê¸€</h3>

        <div>
          <textarea
            id="newCommentContent"
            rows="3"
            style="width: 100%"
          ></textarea>
          <button onclick="submitComment()" class="comment-btn">
            ëŒ“ê¸€ ì‘ì„±
          </button>
        </div>

        <div id="comments-container"></div>
      </div>
      <!-- ëŒ“ê¸€ ì˜ì—­ ë -->

      <!-- ëª©ë¡ìœ¼ë¡œ -->
      <a th:href="@{/posts/page}" class="back-link">ëª©ë¡ìœ¼ë¡œ</a>
    </div>

    <script th:inline="javascript">
      const likeButton = document.getElementById("like");
      const disLikeButton = document.getElementById("dislike");

      const postId = [[${post.postsId}]];
      const postOwnerId = [[${post.userId}]];
      const accessToken = localStorage.getItem("accessToken");
      let currentUserId = null;

      async function fetchCurrentUser() {
        try {
          if (!accessToken) return;

          const res = await fetch("/api/auth/me", {
            headers: {
              "Authorization": "Bearer " + accessToken
            }
          });

          if (!res.ok) throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤");

          const data = await res.json();
          currentUserId = data.userId;


          console.log("ğŸŸ¢ ë¡œê·¸ì¸ ì‚¬ìš©ì ID:", currentUserId);

          loadComments(); // ì‚¬ìš©ì ì •ë³´ê°€ í™•ì¸ëœ í›„ ëŒ“ê¸€ ì¡°íšŒ
        } catch (err) {
          console.error("âŒ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨", err);
        }
      }

      // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
      function loadComments() {
        fetch(`/api/comments/post/${postId}`)
          .then(res => res.json())
          .then(data => renderComments(data));
      }

      function renderComments(comments) {
        const container = document.getElementById("comments-container");
        container.innerHTML = "";

        comments.forEach(comment => {
          const commentEl = buildCommentElement(comment);
          container.appendChild(commentEl);
        });

      likeButton.addEventListener("click", async() => {
        vote('POST', postId, 'LIKE');
      });

      disLikeButton.addEventListener("click", async() => {
        vote('POST', postId ,'DISLIKE');
      });


      function deletePost(postId) {
        if (!confirm('ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;

      }

      function buildCommentElement(comment, isChild = false) {
        const div = document.createElement("div");
        div.style.marginLeft = isChild ? "30px" : "0";
        div.style.borderBottom = "1px solid #ccc";
        div.style.padding = "10px 0";

        const info = document.createElement("p");
        info.innerHTML = `<strong>${comment.nickname}</strong> | ${comment.createAt}`;
        div.appendChild(info);

        const content = document.createElement("p");
        content.textContent = comment.content;
        div.appendChild(content);

        const buttonGroup = document.createElement("div");

        if (currentUserId && Number(currentUserId) === Number(comment.userId)) {
          const editBtn = document.createElement("button");
          editBtn.textContent = "ìˆ˜ì •";
          editBtn.className = "comment-btn";
          editBtn.onclick = () => {
            const newContent = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”", comment.content);
            if (newContent) updateComment(comment.commentId, newContent);
          };
          buttonGroup.appendChild(editBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "ì‚­ì œ";
          deleteBtn.className = "comment-btn delete-btn";
          deleteBtn.onclick = () => deleteComment(comment.commentId);
          buttonGroup.appendChild(deleteBtn);
        }

        if (Number(postOwnerId) === Number(currentUserId) && !comment.answer) {
          const adoptBtn = document.createElement("button");
          adoptBtn.textContent = "ì±„íƒ";
          adoptBtn.className = "comment-btn adopt-btn";
          adoptBtn.onclick = () => adoptComment(comment.commentId);
          buttonGroup.appendChild(adoptBtn);
        }

        const replyBtn = document.createElement("button");
        replyBtn.textContent = "ë‹µê¸€";
        replyBtn.className = "comment-btn";
        replyBtn.onclick = () => {
          const replyContent = prompt("ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");
          if (replyContent) submitComment(replyContent, comment.commentId);
        };
        buttonGroup.appendChild(replyBtn);

        if (comment.answer) {
          const adopted = document.createElement("span");
          adopted.textContent = "âœ… ì±„íƒë¨";
          adopted.className = "adopted-label";
          buttonGroup.appendChild(adopted);
          
        }

        div.appendChild(buttonGroup);

        if (comment.children && comment.children.length > 0) {
          comment.children.forEach(child => {
            const childEl = buildCommentElement(child, true);
            div.appendChild(childEl);
          });
        }

        return div;
      }

      function submitComment(content = null, parentId = null) {
        const textarea = document.getElementById("newCommentContent");
        const commentContent = content || textarea.value.trim();

        if (!commentContent) return alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

        fetch("/api/comments", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + accessToken,
          },
          body: JSON.stringify({
            content: commentContent,
            postId: postId,
            userId: currentUserId,
            parentId: parentId,
          }),
        })
          .then(async res => {
            if (!res.ok) throw new Error("ì‘ì„± ì‹¤íŒ¨: " + res.status);
            const text = await res.text();
            return text ? JSON.parse(text) : {};
          })
          .then(() => {
            textarea.value = "";
            loadComments();
          })
          .catch((err) => alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: " + err.message));
      }

      function updateComment(commentId, newContent) {
        fetch(`/api/comments/${commentId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + accessToken,
          },
          body: JSON.stringify({ content: newContent }),
        })
          .then(res => {
            if (!res.ok) throw new Error("ìˆ˜ì • ì‹¤íŒ¨");
            loadComments();
          })
          .catch(() => alert("ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨"));
      }

      function deleteComment(commentId) {
        if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) return;

        fetch(`/api/comments/${commentId}`, {
          method: "DELETE",
          headers: {
            Authorization: "Bearer " + accessToken,
          },
        })
          .then(res => {
            if (!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
            loadComments();
          })
          .catch(() => alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨"));
      }


      // ê²Œì‹œê¸€ ì¶”ì²œ/ë¹„ì¶”ì²œ API í˜¸ì¶œ
      function vote(targetType, targetId, voteType)  {
        const token = localStorage.getItem("accessToken");

        fetch("/votes", {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token,
            'Content-Type': "application/json"
          },
          body: JSON.stringify({
            targetId: targetId,
            targetType: targetType,
            voteType: voteType
          })
        })
        .then((res) => {
          if (res.ok) {
            // íˆ¬í‘œ ì„±ê³µ ì‹œ ìµœì‹  ê°œìˆ˜ ì¬ì¡°íšŒ
            fetchVoteCounts();
            // ë²„íŠ¼ ìƒíƒœ í† ê¸€
            const likeBtn = document.getElementById('like');
            const dislikeBtn = document.getElementById('dislike');
            if(voteType === 'LIKE') {
              if(likeBtn.classList.contains('active')) {
                likeBtn.classList.remove('active'); // ì·¨ì†Œ
              } else {
                likeBtn.classList.add('active');
                dislikeBtn.classList.remove('active');
              }
            } else if(voteType === 'DISLIKE') {
              if(dislikeBtn.classList.contains('active')) {
                dislikeBtn.classList.remove('active'); // ì·¨ì†Œ
              } else {
                dislikeBtn.classList.add('active');
                likeBtn.classList.remove('active');
              }
            }
            alert(voteType === 'LIKE' ? 'ì¶”ì²œ ì™„ë£Œ!' : 'ë¹„ì¶”ì²œ ì™„ë£Œ!');
          } else {
            alert('íˆ¬í‘œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        });
      }

      // ì¶”ì²œ ë¹„ì¶”ì²œ ìˆ˜
      function fetchVoteCounts() {
        fetch(`/votes/count?targetId=${postId}&targetType=POST`)
        .then(res => res.json())
        .then(data => {
          console.log(data);
          document.getElementById('likeCount').textContent = data.likeCount;
          document.getElementById('dislikeCount').textContent = data.dislikeCount;
        });
      }

      // í˜„ì¬ ì‚¬ìš©ìì˜ íˆ¬í‘œ ìƒíƒœ
      function fetchUserVote() {
        fetch(`/votes/user?targetId=${postId}&targetType=POST`, {
          headers: {
            Authorization: 'Bearer ' + localStorage.getItem('accessToken')
          }
        })
        .then(res => {
          if(res.ok) return res.json();
          return null;
        })
        .then(data => {
          if(!data) return;
          if(data.voteType === 'LIKE') {
            document.getElementById('like').classList.add('active');
          } else if(data.voteType === 'DISLIKE') {
            document.getElementById('dislike').classList.add('active');
          }
        });
      }

      function adoptComment(commentId) {
        if (!confirm("ì´ ëŒ“ê¸€ì„ ì±„íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/api/comments/${commentId}/adopt`, {
          method: "POST",
          headers: {
            Authorization: "Bearer " + accessToken,
          },
        })
          .then(res => {
            if (!res.ok) throw new Error("ì±„íƒ ì‹¤íŒ¨");
            loadComments();
          })
          .catch(() => alert("ëŒ“ê¸€ ì±„íƒ ì‹¤íŒ¨"));
      }

      // ì¡°íšŒìˆ˜ ì¦ê°€ì™€ ì‚¬ìš©ì ì¡°íšŒ ì‹œì‘
      window.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URL(window.location.href);
        if (urlParams.searchParams.get('from') !== 'edit') {
          fetch('/posts/' + postId + '/viewCount', {
            method: 'POST'
          });
        }
        
        fetch('/posts/' + postId + '/viewCount', {
          method: 'POST'
        });

        fetchVoteCounts();
        fetchUserVote();
        fetchCurrentUser();
      });

    </script>
<!--    <script>-->
<!--      console.log("ğŸ§ª localStorage token:", localStorage.getItem("accessToken"));-->

<!--      fetch("/api/auth/me", {-->
<!--        headers: {-->
<!--          Authorization: "Bearer " + localStorage.getItem("accessToken"),-->
<!--        }-->
<!--      })-->
<!--      .then(res => {-->
<!--        console.log("ğŸ§ª /api/auth/me status:", res.status);-->
<!--        return res.json();-->
<!--      })-->
<!--      .then(data => console.log("ğŸ§ª /api/auth/me result:", data))-->
<!--      .catch(err => console.error("âŒ fetch ì‹¤íŒ¨:", err));-->
<!--    </script>-->
  </body>
</html>